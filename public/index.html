<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenMailer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="app">
    <!-- Mobile Header -->
    <header class="mobile-header">
        <a href="#" class="logo">
            <div class="logo-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-6l-2 3h-4l-2-3H2"/><path d="M5.45 5.11L2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6l-3.45-6.89A2 2 0 0016.76 4H7.24a2 2 0 00-1.79 1.11z"/></svg>
            </div>
            <span class="logo-text">OpenMailer</span>
        </a>
        <button class="menu-toggle" onclick="toggleSidebar()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        </button>
    </header>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="#" class="logo">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-6l-2 3h-4l-2-3H2"/><path d="M5.45 5.11L2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6l-3.45-6.89A2 2 0 0016.76 4H7.24a2 2 0 00-1.79 1.11z"/></svg>
                </div>
                <span class="logo-text">OpenMailer</span>
            </a>
        </div>
        <nav class="sidebar-nav">
            <button class="nav-item active" data-section="dashboard">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="9" rx="1"/><rect x="14" y="3" width="7" height="5" rx="1"/><rect x="14" y="12" width="7" height="9" rx="1"/><rect x="3" y="16" width="7" height="5" rx="1"/></svg>
                <span>Dashboard</span>
            </button>
            <button class="nav-item" data-section="campaigns">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                <span>Campagnes</span>
            </button>
            <button class="nav-item" data-section="contacts">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
                <span>Contacts</span>
            </button>
            <button class="nav-item" data-section="new-campaign">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                <span>Nouvelle campagne</span>
            </button>
            <button class="nav-item" data-section="settings">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
                <span>Param√®tres</span>
            </button>
        </nav>
        <div class="sidebar-footer">
            <button class="sync-btn" onclick="manualSync()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
                <span>Synchroniser</span>
            </button>
            <div class="sync-status" id="sync-status">Auto-sync: 30s</div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main">
        <!-- Dashboard Section -->
        <section id="dashboard-section" class="section active">
            <div class="page-header">
                <h1 class="page-title">Dashboard</h1>
                <p class="page-subtitle">Vue d'ensemble de vos campagnes email</p>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon blue"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></div>
                    </div>
                    <div class="stat-value" id="stat-daily">0/50</div>
                    <div class="stat-label">Envois aujourd'hui</div>
                    <div class="stat-progress"><div class="stat-progress-bar" id="daily-progress" style="width: 0%"></div></div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div>
                    </div>
                    <div class="stat-value" id="stat-sent">0</div>
                    <div class="stat-label">Total envoy√©s</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon orange"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></div>
                    </div>
                    <div class="stat-value" id="stat-opened">0</div>
                    <div class="stat-label">Ouvertures</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon red"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></div>
                    </div>
                    <div class="stat-value" id="stat-clicked">0</div>
                    <div class="stat-label">Clics</div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>Tracking r√©cent</h2>
                </div>
                <div class="card-body">
                    <div class="table-wrapper">
                        <table class="table">
                            <thead><tr><th>Contact</th><th>Entreprise</th><th>Envoy√©</th><th>Statut</th><th>Ouvert le</th></tr></thead>
                            <tbody id="tracking-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Campaigns Section -->
        <section id="campaigns-section" class="section">
            <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 class="page-title">Campagnes</h1>
                    <p class="page-subtitle">G√©rez vos campagnes d'emailing</p>
                </div>
                <button class="btn btn-primary" onclick="showSection('new-campaign')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    Nouvelle campagne
                </button>
            </div>
            <div class="campaigns-grid" id="campaigns-list"></div>
        </section>

        <!-- Campaign Detail Section -->
        <section id="campaign-detail-section" class="section">
            <button class="back-btn" onclick="showSection('campaigns')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
                Retour aux campagnes
            </button>
            <div class="page-header">
                <h1 class="page-title" id="campaign-detail-title">D√©tails campagne</h1>
            </div>
            <div id="campaign-detail-content"></div>
        </section>

        <!-- Contacts Section -->
        <section id="contacts-section" class="section">
            <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 class="page-title">Contacts</h1>
                    <p class="page-subtitle">G√©rez votre liste de contacts</p>
                </div>
                <div>
                    <input type="file" id="csv-file" accept=".csv" style="display:none;" onchange="importCSV(this)">
                    <button class="btn btn-primary" onclick="document.getElementById('csv-file').click()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        Importer CSV
                    </button>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="table-wrapper">
                        <table class="table">
                            <thead><tr><th>Email</th><th>Nom</th><th>Entreprise</th><th>Statut</th></tr></thead>
                            <tbody id="contacts-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- New Campaign Section -->
        <section id="new-campaign-section" class="section">
            <button class="back-btn" onclick="showSection('campaigns')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
                Retour aux campagnes
            </button>
            <div class="page-header">
                <h1 class="page-title">Nouvelle campagne</h1>
                <p class="page-subtitle">R√©digez votre email comme un message classique</p>
            </div>
            <div class="campaign-editor-layout">
                <form id="campaign-form" class="form-card editor-panel">
                    <div class="form-group">
                        <label class="form-label">Nom de la campagne</label>
                        <input type="text" class="form-input" id="campaign-name" placeholder="Ex: Lancement produit Q1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Objet de l'email</label>
                        <input type="text" class="form-input" id="campaign-subject" placeholder="Ex: D√©couvrez notre nouvelle offre" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contenu de l'email</label>
                        <div class="email-editor">
                            <div class="editor-toolbar">
                                <button type="button" class="toolbar-btn" onclick="formatText('bold')" title="Gras">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 4h8a4 4 0 014 4 4 4 0 01-4 4H6z"/><path d="M6 12h9a4 4 0 014 4 4 4 0 01-4 4H6z"/></svg>
                                </button>
                                <button type="button" class="toolbar-btn" onclick="formatText('italic')" title="Italique">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="4" x2="10" y2="4"/><line x1="14" y1="20" x2="5" y2="20"/><line x1="15" y1="4" x2="9" y2="20"/></svg>
                                </button>
                                <button type="button" class="toolbar-btn" onclick="formatText('underline')" title="Soulign√©">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 3v7a6 6 0 006 6 6 6 0 006-6V3"/><line x1="4" y1="21" x2="20" y2="21"/></svg>
                                </button>
                                <div class="toolbar-separator"></div>
                                <button type="button" class="toolbar-btn" onclick="insertLink()" title="Lien">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>
                                </button>
                                <button type="button" class="toolbar-btn" onclick="insertImage()" title="Image">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                                </button>
                                <div class="toolbar-separator"></div>
                                <button type="button" class="toolbar-btn" onclick="insertVariable('name')" title="Ins√©rer {{name}}">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                </button>
                                <button type="button" class="toolbar-btn" onclick="insertVariable('company')" title="Ins√©rer {{company}}">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                                </button>
                            </div>
                            <div class="editor-content" id="email-content" contenteditable="true" data-placeholder="Bonjour {{name}},

√âcrivez votre message ici...

Cordialement,
Votre signature"></div>
                        </div>
                        <div class="variables-help">
                            <span style="font-size: 0.8rem; color: var(--text-muted); margin-right: 8px;">Variables :</span>
                            <span class="var-tag" onclick="insertVariable('name')">{{name}}</span>
                            <span class="var-tag" onclick="insertVariable('company')">{{company}}</span>
                            <span class="var-tag" onclick="insertVariable('email')">{{email}}</span>
                        </div>
                        <p class="form-hint">üí° Cliquez sur une image pour la redimensionner ou la supprimer</p>
                        <input type="file" id="image-upload" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">
                    </div>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button type="submit" class="btn btn-primary">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                            Cr√©er la campagne
                        </button>
                    </div>
                </form>
                <div class="preview-panel">
                    <div class="preview-header">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                        <span>Aper√ßu en direct</span>
                    </div>
                    <div class="preview-email-header">
                        <div class="preview-field"><span class="preview-label">De:</span><span>votre@email.com</span></div>
                        <div class="preview-field"><span class="preview-label">√Ä:</span><span>Jean Dupont &lt;jean@exemple.fr&gt;</span></div>
                        <div class="preview-field"><span class="preview-label">Objet:</span><span id="preview-subject">Votre objet ici...</span></div>
                    </div>
                    <div class="preview-content" id="email-preview">
                        <p style="color: var(--text-muted); font-style: italic;">Commencez √† √©crire pour voir l'aper√ßu...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Settings Section -->
        <section id="settings-section" class="section">
            <div class="page-header">
                <h1 class="page-title">Param√®tres</h1>
                <p class="page-subtitle">Configurez votre application</p>
            </div>
            
            <div class="form-card" style="max-width: 600px;">
                <h3 style="margin-bottom: 24px; font-size: 1.1rem;">Limite d'envoi journali√®re</h3>
                
                <div class="alert" style="background: #EFF6FF; border: 1px solid #BFDBFE; color: #1E40AF; margin-bottom: 24px;">
                    <div class="alert-content" style="flex-direction: column; align-items: flex-start; gap: 8px;">
                        <strong>üí° Pourquoi une limite ?</strong>
                        <p style="margin: 0; font-size: 0.85rem; line-height: 1.5;">
                            Les fournisseurs email (Gmail, Outlook...) surveillent les envois massifs. 
                            Une limite de <strong>50 emails/jour</strong> permet d'√©viter :
                        </p>
                        <ul style="margin: 8px 0 0 20px; font-size: 0.85rem; line-height: 1.6;">
                            <li>Le <strong>soft ban</strong> temporaire de votre compte</li>
                            <li>Le classement en <strong>spam</strong> de vos emails</li>
                            <li>La d√©gradation de votre <strong>r√©putation d'exp√©diteur</strong></li>
                        </ul>
                        <p style="margin: 8px 0 0; font-size: 0.85rem;">
                            Gmail gratuit limite √† ~500/jour, mais 50 est recommand√© pour le cold emailing.
                        </p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Nombre maximum d'emails par jour</label>
                    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                        <input type="number" class="form-input" id="settings-daily-limit" min="1" max="500" value="50" style="max-width: 120px;">
                        <span style="color: var(--text-muted); font-size: 0.85rem;">emails / jour</span>
                    </div>
                    <p class="form-hint">Recommand√© : 50 pour √©viter les probl√®mes de d√©livrabilit√©</p>
                </div>
                
                <div style="display: flex; gap: 12px; margin-top: 24px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="saveSettings()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                        Enregistrer
                    </button>
                    <button class="btn btn-secondary" onclick="document.getElementById('settings-daily-limit').value = 50;">
                        R√©initialiser (50)
                    </button>
                </div>
            </div>
            
            <div class="form-card" style="max-width: 600px; margin-top: 24px;">
                <h3 style="margin-bottom: 16px; font-size: 1.1rem;">√Ä propos du tracking</h3>
                
                <div class="alert" style="background: #FFF7ED; border: 1px solid #FED7AA; color: #9A3412;">
                    <div class="alert-content" style="flex-direction: column; align-items: flex-start; gap: 8px;">
                        <strong>‚ö†Ô∏è Tracking local uniquement</strong>
                        <p style="margin: 0; font-size: 0.85rem; line-height: 1.5;">
                            Le tracking des ouvertures fonctionne via un <strong>pixel invisible</strong> dans l'email. 
                            Pour que ce pixel soit accessible, votre serveur doit √™tre <strong>accessible publiquement</strong> (pas en localhost).
                        </p>
                        <p style="margin: 8px 0 0; font-size: 0.85rem; line-height: 1.5;">
                            <strong>En local :</strong> Le tracking ne fonctionnera pas car les destinataires ne peuvent pas atteindre localhost.<br>
                            <strong>En production :</strong> D√©ployez sur un serveur avec une URL publique (ex: VPS, Heroku, Railway...).
                        </p>
                    </div>
                </div>
            </div>
        </section>
    </main>
</div>

<script>
const API = '';
let currentSettings = { dailyLimit: 50 };

// Mobile sidebar toggle
function toggleSidebar() {
    document.querySelector('.sidebar').classList.toggle('open');
    document.querySelector('.sidebar-overlay').classList.toggle('open');
}

// Load settings on init
async function loadSettings() {
    const res = await fetch(`${API}/api/settings`);
    currentSettings = await res.json();
    document.getElementById('settings-daily-limit').value = currentSettings.dailyLimit;
}

// Navigation
document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', () => {
        showSection(item.dataset.section);
        if (window.innerWidth <= 768) toggleSidebar();
    });
});

function showSection(section) {
    document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
    document.getElementById(`${section}-section`).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    const navItem = document.querySelector(`[data-section="${section}"]`);
    if (navItem) navItem.classList.add('active');
    
    if (section === 'campaigns') loadCampaigns();
    if (section === 'contacts') loadContacts();
    if (section === 'dashboard') { loadStats(); loadTrackingTable(); }
    if (section === 'settings') loadSettings();
}

// Stats
async function loadStats() {
    const res = await fetch(`${API}/api/stats`);
    const stats = await res.json();
    document.getElementById('stat-daily').textContent = `${stats.dailySent}/${stats.dailyLimit}`;
    document.getElementById('stat-sent').textContent = stats.totalSent;
    document.getElementById('stat-opened').textContent = stats.totalOpened;
    document.getElementById('stat-clicked').textContent = stats.totalClicked;
    document.getElementById('daily-progress').style.width = `${(stats.dailySent/stats.dailyLimit)*100}%`;
}

// Tracking Table
async function loadTrackingTable() {
    const res = await fetch(`${API}/api/tracking-details`);
    const emails = await res.json();
    const html = emails.slice(0, 20).map(e => `
        <tr>
            <td><div class="contact-cell"><span class="contact-name">${e.name || 'N/A'}</span><span class="contact-email">${e.email}</span></div></td>
            <td>${e.company || '-'}</td>
            <td>${new Date(e.sent_at).toLocaleDateString('fr-FR')}</td>
            <td>${e.opened_at ? '<span class="badge badge-success">Ouvert</span>' : '<span class="badge badge-danger">Non ouvert</span>'}${e.clicked_at ? ' <span class="badge badge-info">Cliqu√©</span>' : ''}</td>
            <td>${e.opened_at ? new Date(e.opened_at).toLocaleString('fr-FR') : '-'}</td>
        </tr>
    `).join('');
    document.getElementById('tracking-table').innerHTML = html || '<tr><td colspan="5" class="empty-state"><p>Aucun email envoy√©</p></td></tr>';
}

// Campaigns
async function loadCampaigns() {
    const res = await fetch(`${API}/api/campaigns`);
    const campaigns = await res.json();
    const trackingRes = await fetch(`${API}/api/tracking-details`);
    const allEmails = await trackingRes.json();
    
    const campaignsHtml = await Promise.all(campaigns.map(async c => {
        const emails = allEmails.filter(e => e.campaign_id === c.id);
        const sent = emails.length;
        const opened = emails.filter(e => e.opened_at).length;
        const openRate = sent > 0 ? Math.round((opened/sent)*100) : 0;
        
        const pendingRes = await fetch(`${API}/api/campaigns/${c.id}/pending`);
        const pending = await pendingRes.json();
        
        return `
        <div class="campaign-card">
            <div class="campaign-header">
                <div class="campaign-info"><h3>${c.name}</h3><p>${c.subject}</p></div>
                <div class="campaign-actions">
                    <button class="btn btn-secondary btn-sm" onclick="viewCampaignDetail(${c.id})"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg><span class="btn-text">Tracking</span></button>
                    <button class="btn btn-secondary btn-sm" onclick="viewCampaign(${c.id})"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg><span class="btn-text">Aper√ßu</span></button>
                    <button class="btn btn-secondary btn-sm" onclick="testCampaign(${c.id})"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg><span class="btn-text">Test</span></button>
                    ${pending.count > 0 ? `<button class="btn btn-primary btn-sm" onclick="sendCampaign(${c.id}, ${pending.count})"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg><span class="btn-text">Envoyer (${pending.count})</span></button>` : ''}
                    ${sent - opened > 0 ? `<button class="btn btn-warning btn-sm" onclick="resendUnopened(${c.id})"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg><span class="btn-text">Relancer non ouverts (${sent-opened})</span></button>` : ''}
                    ${opened > 0 ? `<button class="btn btn-secondary btn-sm" onclick="resendOpened(${c.id})"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg><span class="btn-text">Relancer ouverts (${opened})</span></button>` : ''}
                </div>
            </div>
            <div class="campaign-stats">
                <div class="campaign-stat"><div class="campaign-stat-value">${sent}</div><div class="campaign-stat-label">Envoy√©s</div></div>
                <div class="campaign-stat"><div class="campaign-stat-value success">${opened}</div><div class="campaign-stat-label">Ouverts</div></div>
                <div class="campaign-stat"><div class="campaign-stat-value primary">${openRate}%</div><div class="campaign-stat-label">Taux ouv.</div></div>
                <div class="campaign-stat"><div class="campaign-stat-value danger">${sent - opened}</div><div class="campaign-stat-label">Non ouverts</div></div>
                <div class="campaign-stat ${pending.count > 0 ? 'highlight' : ''}"><div class="campaign-stat-value ${pending.count > 0 ? 'primary' : ''}">${pending.count}</div><div class="campaign-stat-label">En attente</div></div>
            </div>
        </div>`;
    }));
    document.getElementById('campaigns-list').innerHTML = campaignsHtml.join('') || '<div class="empty-state"><p>Aucune campagne</p></div>';
}

// Campaign Detail
async function viewCampaignDetail(id) {
    const [campaignRes, trackingRes] = await Promise.all([fetch(`${API}/api/campaigns/${id}`), fetch(`${API}/api/tracking-details`)]);
    const campaign = await campaignRes.json();
    const allEmails = await trackingRes.json();
    const emails = allEmails.filter(e => e.campaign_id === id);
    const opened = emails.filter(e => e.opened_at);
    const notOpened = emails.filter(e => !e.opened_at);
    
    document.getElementById('campaign-detail-title').textContent = campaign.name;
    
    const html = `
        <div class="stats-grid" style="margin-bottom: 24px;">
            <div class="stat-card"><div class="stat-value">${emails.length}</div><div class="stat-label">Envoy√©s</div></div>
            <div class="stat-card"><div class="stat-value" style="color: var(--accent-success)">${opened.length}</div><div class="stat-label">Ouverts</div></div>
            <div class="stat-card"><div class="stat-value" style="color: var(--accent-danger)">${notOpened.length}</div><div class="stat-label">Non ouverts</div></div>
            <div class="stat-card"><div class="stat-value">${emails.length > 0 ? Math.round((opened.length/emails.length)*100) : 0}%</div><div class="stat-label">Taux d'ouverture</div></div>
        </div>
        ${notOpened.length > 0 ? `<div class="alert alert-warning"><div class="alert-content"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg><span><strong>${notOpened.length} contacts</strong> n'ont pas ouvert cet email</span></div><button class="btn btn-warning btn-sm" onclick="resendUnopened(${id})">Relancer non ouverts</button></div>` : `<div class="alert alert-success"><div class="alert-content"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg><span>Tous les contacts ont ouvert cet email !</span></div></div>`}
        ${opened.length > 0 ? `<div class="alert" style="background: #EFF6FF; border: 1px solid #BFDBFE; color: #1E40AF;"><div class="alert-content"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg><span><strong>${opened.length} contacts</strong> ont ouvert cet email</span></div><button class="btn btn-secondary btn-sm" onclick="resendOpened(${id})">Relancer ouverts</button></div>` : ''}
        <div class="tabs"><button class="tab active" onclick="switchTab(this, 'opened-tab')">Ouverts (${opened.length})</button><button class="tab" onclick="switchTab(this, 'not-opened-tab')">Non ouverts (${notOpened.length})</button></div>
        <div id="opened-tab" class="card"><div class="card-body"><div class="table-wrapper"><table class="table"><thead><tr><th>Contact</th><th>Email</th><th>Entreprise</th><th>Ouvert le</th></tr></thead><tbody>${opened.map(e => `<tr><td><strong>${e.name || 'N/A'}</strong></td><td>${e.email}</td><td>${e.company || '-'}</td><td><span class="badge badge-success">${new Date(e.opened_at).toLocaleString('fr-FR')}</span></td></tr>`).join('') || '<tr><td colspan="4" class="empty-state"><p>Aucun</p></td></tr>'}</tbody></table></div></div></div>
        <div id="not-opened-tab" class="card" style="display: none;"><div class="card-body"><div class="table-wrapper"><table class="table"><thead><tr><th>Contact</th><th>Email</th><th>Entreprise</th><th>Envoy√© le</th></tr></thead><tbody>${notOpened.map(e => `<tr><td><strong>${e.name || 'N/A'}</strong></td><td>${e.email}</td><td>${e.company || '-'}</td><td><span class="badge badge-danger">${new Date(e.sent_at).toLocaleString('fr-FR')}</span></td></tr>`).join('') || '<tr><td colspan="4" class="empty-state"><p>Aucun</p></td></tr>'}</tbody></table></div></div></div>`;
    
    document.getElementById('campaign-detail-content').innerHTML = html;
    document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
    document.getElementById('campaign-detail-section').classList.add('active');
}

function switchTab(btn, tabId) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('#campaign-detail-content .card').forEach(c => c.style.display = 'none');
    document.getElementById(tabId).style.display = 'block';
}

// Contacts
async function loadContacts() {
    const res = await fetch(`${API}/api/contacts`);
    const contacts = await res.json();
    const html = contacts.map(c => `<tr><td>${c.email}</td><td>${c.name || '-'}</td><td>${c.company || '-'}</td><td><span class="badge badge-success">Actif</span></td></tr>`).join('');
    document.getElementById('contacts-table').innerHTML = html || '<tr><td colspan="4" class="empty-state"><p>Aucun contact</p></td></tr>';
}

async function importCSV(input) {
    const file = input.files[0];
    if (!file) return;
    const formData = new FormData();
    formData.append('file', file);
    const res = await fetch(`${API}/api/contacts/import`, { method: 'POST', body: formData });
    const result = await res.json();
    alert(`${result.imported} contacts import√©s sur ${result.total}`);
    loadContacts();
    input.value = '';
}

// Campaign Actions
async function sendCampaign(id, pendingCount) {
    if (!confirm(`Envoyer cette campagne √† ${pendingCount} nouveau(x) contact(s) ?`)) return;
    const res = await fetch(`${API}/api/campaigns/${id}/send`, { method: 'POST' });
    const result = await res.json();
    if (result.error) { alert(result.error); } else { alert(`${result.sent} emails envoy√©s ! Reste ${result.remaining} envois aujourd'hui.`); }
    loadStats(); loadCampaigns();
}

async function viewCampaign(id) { window.open(`${API}/api/campaigns/${id}/preview`, '_blank'); }

async function testCampaign(id) {
    const email = prompt('Email de test :');
    if (!email) return;
    const res = await fetch(`${API}/api/campaigns/${id}/test`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email }) });
    const result = await res.json();
    alert(result.success ? 'Email de test envoy√© √† ' + email : 'Erreur: ' + result.error);
}

async function resendUnopened(id) {
    const notOpenedRes = await fetch(`${API}/api/campaigns/${id}/not-opened`);
    const notOpened = await notOpenedRes.json();
    if (notOpened.length === 0) { alert('Tous les contacts ont d√©j√† ouvert cet email !'); return; }
    if (!confirm(`Relancer ${notOpened.length} contact(s) qui n'ont pas ouvert ?`)) return;
    const res = await fetch(`${API}/api/campaigns/${id}/resend-unopened`, { method: 'POST' });
    const result = await res.json();
    if (result.error) { alert('Erreur: ' + result.error); } else { alert(`${result.sent} emails de relance envoy√©s.`); loadStats(); loadCampaigns(); }
}

async function resendOpened(id) {
    const openedRes = await fetch(`${API}/api/campaigns/${id}/opened`);
    const opened = await openedRes.json();
    if (opened.length === 0) { alert('Aucun contact n\'a ouvert cet email.'); return; }
    if (!confirm(`Relancer ${opened.length} contact(s) qui ont ouvert ?`)) return;
    const res = await fetch(`${API}/api/campaigns/${id}/resend-opened`, { method: 'POST' });
    const result = await res.json();
    if (result.error) { alert('Erreur: ' + result.error); } else { alert(`${result.sent} emails de relance envoy√©s.`); loadStats(); loadCampaigns(); }
}

// Email Editor Functions
function formatText(command) {
    document.execCommand(command, false, null);
    document.getElementById('email-content').focus();
}

function insertLink() {
    const url = prompt('URL du lien :');
    if (url) document.execCommand('createLink', false, url);
}

function insertImage() {
    document.getElementById('image-upload').click();
}

function handleImageUpload(input) {
    const file = input.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = document.createElement('img');
        img.src = e.target.result;
        img.style.maxWidth = '100%';
        img.style.height = 'auto';
        img.style.borderRadius = '8px';
        img.style.margin = '12px 0';
        img.onclick = function() { selectImage(this); };
        
        const editor = document.getElementById('email-content');
        editor.focus();
        
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            range.insertNode(img);
            range.setStartAfter(img);
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
        } else {
            editor.appendChild(img);
        }
        updatePreview();
    };
    reader.readAsDataURL(file);
    input.value = '';
}

// Image selection and controls
let selectedImage = null;
let imageToolbar = null;

function selectImage(img) {
    // Deselect previous
    if (selectedImage) {
        selectedImage.classList.remove('selected');
    }
    
    // Select new
    selectedImage = img;
    img.classList.add('selected');
    
    // Show toolbar
    showImageToolbar(img);
}

function showImageToolbar(img) {
    removeImageToolbar();
    
    // Detect current alignment
    const style = img.style;
    const float = style.float || 'none';
    const display = style.display || '';
    const margin = style.marginLeft || '';
    
    let currentAlign = 'inline';
    if (display === 'block' && margin === 'auto') currentAlign = 'center';
    else if (display === 'block' && float === 'none' && style.marginRight === 'auto') currentAlign = 'left';
    else if (display === 'block' && float === 'none' && style.marginLeft === 'auto') currentAlign = 'right';
    else if (float === 'left') currentAlign = 'wrap-left';
    else if (float === 'right') currentAlign = 'wrap-right';
    
    imageToolbar = document.createElement('div');
    imageToolbar.className = 'image-toolbar';
    imageToolbar.innerHTML = `
        <div class="toolbar-row">
            <span class="size-label">Largeur:</span>
            <input type="number" class="size-input" value="${img.width || 300}" min="50" max="800" onchange="resizeImage(this.value)">
            <span class="size-label">px</span>
            <button onclick="resizeImagePreset(100)" title="100%">100%</button>
            <button onclick="resizeImagePreset(75)" title="75%">75%</button>
            <button onclick="resizeImagePreset(50)" title="50%">50%</button>
        </div>
        <div class="toolbar-divider"></div>
        <div class="toolbar-row">
            <button onclick="alignImage('inline')" title="En ligne avec le texte" class="${currentAlign === 'inline' ? 'active' : ''}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><rect x="6" y="6" width="12" height="12" rx="1"/></svg>
            </button>
            <div class="toolbar-sep"></div>
            <button onclick="alignImage('left')" title="S√©parer - Aligner √† gauche" class="${currentAlign === 'left' ? 'active' : ''}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><rect x="3" y="6" width="10" height="10" rx="1"/><line x1="3" y1="20" x2="21" y2="20"/></svg>
            </button>
            <button onclick="alignImage('center')" title="S√©parer - Centrer" class="${currentAlign === 'center' ? 'active' : ''}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><rect x="7" y="6" width="10" height="10" rx="1"/><line x1="3" y1="20" x2="21" y2="20"/></svg>
            </button>
            <button onclick="alignImage('right')" title="S√©parer - Aligner √† droite" class="${currentAlign === 'right' ? 'active' : ''}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><rect x="11" y="6" width="10" height="10" rx="1"/><line x1="3" y1="20" x2="21" y2="20"/></svg>
            </button>
            <div class="toolbar-sep"></div>
            <button onclick="alignImage('wrap-left')" title="Habiller - Texte √† droite" class="${currentAlign === 'wrap-left' ? 'active' : ''}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><rect x="3" y="3" width="8" height="8" rx="1"/><line x1="14" y1="4" x2="21" y2="4"/><line x1="14" y1="8" x2="21" y2="8"/><line x1="3" y1="16" x2="21" y2="16"/><line x1="3" y1="20" x2="21" y2="20"/></svg>
            </button>
            <button onclick="alignImage('wrap-right')" title="Habiller - Texte √† gauche" class="${currentAlign === 'wrap-right' ? 'active' : ''}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><rect x="13" y="3" width="8" height="8" rx="1"/><line x1="3" y1="4" x2="10" y2="4"/><line x1="3" y1="8" x2="10" y2="8"/><line x1="3" y1="16" x2="21" y2="16"/><line x1="3" y1="20" x2="21" y2="20"/></svg>
            </button>
            <div class="toolbar-sep"></div>
            <button onclick="addImageLink()" title="Ajouter un lien">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>
            </button>
            <button class="danger" onclick="deleteSelectedImage()" title="Supprimer">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
            </button>
        </div>
    `;
    
    // Position toolbar above image
    const rect = img.getBoundingClientRect();
    
    imageToolbar.style.position = 'fixed';
    imageToolbar.style.left = `${Math.max(10, rect.left)}px`;
    imageToolbar.style.top = `${Math.max(10, rect.top - 90)}px`;
    
    document.body.appendChild(imageToolbar);
}

// Image alignment functions
function alignImage(alignment) {
    if (!selectedImage) return;
    
    // Reset all styles first
    selectedImage.style.display = '';
    selectedImage.style.float = '';
    selectedImage.style.marginLeft = '';
    selectedImage.style.marginRight = '';
    selectedImage.style.clear = '';
    
    switch(alignment) {
        case 'inline':
            // Default inline behavior
            selectedImage.style.verticalAlign = 'middle';
            break;
        case 'left':
            selectedImage.style.display = 'block';
            selectedImage.style.marginRight = 'auto';
            selectedImage.style.marginLeft = '0';
            break;
        case 'center':
            selectedImage.style.display = 'block';
            selectedImage.style.marginLeft = 'auto';
            selectedImage.style.marginRight = 'auto';
            break;
        case 'right':
            selectedImage.style.display = 'block';
            selectedImage.style.marginLeft = 'auto';
            selectedImage.style.marginRight = '0';
            break;
        case 'wrap-left':
            selectedImage.style.float = 'left';
            selectedImage.style.marginRight = '16px';
            selectedImage.style.marginBottom = '8px';
            break;
        case 'wrap-right':
            selectedImage.style.float = 'right';
            selectedImage.style.marginLeft = '16px';
            selectedImage.style.marginBottom = '8px';
            break;
    }
    
    // Refresh toolbar to show active state
    showImageToolbar(selectedImage);
    updatePreview();
}

function addImageLink() {
    if (!selectedImage) return;
    
    // Check if image is already wrapped in a link
    const parent = selectedImage.parentElement;
    let currentUrl = '';
    if (parent && parent.tagName === 'A') {
        currentUrl = parent.href;
    }
    
    const url = prompt('URL du lien (laisser vide pour supprimer):', currentUrl);
    
    if (url === null) return; // Cancelled
    
    if (url === '') {
        // Remove link if exists
        if (parent && parent.tagName === 'A') {
            parent.replaceWith(selectedImage);
        }
    } else {
        // Add or update link
        if (parent && parent.tagName === 'A') {
            parent.href = url;
        } else {
            const link = document.createElement('a');
            link.href = url;
            link.target = '_blank';
            selectedImage.parentNode.insertBefore(link, selectedImage);
            link.appendChild(selectedImage);
        }
    }
    updatePreview();
}

function removeImageToolbar() {
    if (imageToolbar) {
        imageToolbar.remove();
        imageToolbar = null;
    }
}

function resizeImage(width) {
    if (selectedImage) {
        selectedImage.style.width = width + 'px';
        selectedImage.style.height = 'auto';
        updatePreview();
    }
}

function resizeImagePreset(percent) {
    if (selectedImage) {
        const editor = document.getElementById('email-content');
        const maxWidth = editor.clientWidth - 40;
        const newWidth = Math.round(maxWidth * (percent / 100));
        selectedImage.style.width = newWidth + 'px';
        selectedImage.style.height = 'auto';
        
        // Update input
        const input = imageToolbar.querySelector('.size-input');
        if (input) input.value = newWidth;
        updatePreview();
    }
}

function deleteSelectedImage() {
    if (selectedImage) {
        selectedImage.remove();
        selectedImage = null;
        removeImageToolbar();
        updatePreview();
    }
}

// Close toolbar when clicking outside
document.addEventListener('click', function(e) {
    if (imageToolbar && !imageToolbar.contains(e.target) && e.target !== selectedImage) {
        if (selectedImage) selectedImage.classList.remove('selected');
        selectedImage = null;
        removeImageToolbar();
    }
});

// Live Preview
function updatePreview() {
    const editor = document.getElementById('email-content');
    const subjectInput = document.getElementById('campaign-subject');
    const previewContent = document.getElementById('email-preview');
    const previewSubject = document.getElementById('preview-subject');
    
    if (!previewContent) return;
    
    // Update subject
    if (previewSubject && subjectInput) {
        previewSubject.textContent = subjectInput.value || 'Votre objet ici...';
    }
    
    // Get content and replace variables with sample data
    let content = editor.innerHTML;
    
    // Replace variables with sample values
    content = content.replace(/\{\{name\}\}/g, '<strong>Jean Dupont</strong>');
    content = content.replace(/\{\{company\}\}/g, '<strong>Acme Corp</strong>');
    content = content.replace(/\{\{email\}\}/g, '<strong>jean@exemple.fr</strong>');
    
    // Show preview
    if (content.trim() === '' || content === '<br>') {
        previewContent.innerHTML = '<p style="color: var(--text-muted); font-style: italic;">Commencez √† √©crire pour voir l\'aper√ßu...</p>';
    } else {
        previewContent.innerHTML = content;
    }
}

// Setup drag & drop for images
document.addEventListener('DOMContentLoaded', function() {
    const editor = document.getElementById('email-content');
    if (editor) {
        // Live preview on input
        editor.addEventListener('input', updatePreview);
        
        // Subject preview
        const subjectInput = document.getElementById('campaign-subject');
        if (subjectInput) {
            subjectInput.addEventListener('input', updatePreview);
        }
        
        // Make existing images clickable
        editor.addEventListener('click', function(e) {
            if (e.target.tagName === 'IMG') {
                selectImage(e.target);
            }
        });
        
        editor.addEventListener('dragover', function(e) {
            e.preventDefault();
            editor.style.background = '#EFF6FF';
        });
        
        editor.addEventListener('dragleave', function(e) {
            editor.style.background = '';
        });
        
        editor.addEventListener('drop', function(e) {
            e.preventDefault();
            editor.style.background = '';
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(ev) {
                    const img = document.createElement('img');
                    img.src = ev.target.result;
                    img.style.maxWidth = '100%';
                    img.style.height = 'auto';
                    img.style.borderRadius = '8px';
                    img.style.margin = '12px 0';
                    img.onclick = function() { selectImage(this); };
                    
                    const selection = window.getSelection();
                    if (selection.rangeCount > 0) {
                        const range = selection.getRangeAt(0);
                        range.insertNode(img);
                    } else {
                        editor.appendChild(img);
                    }
                    updatePreview();
                };
                reader.readAsDataURL(files[0]);
            }
        });
    }
});

function insertVariable(varName) {
    const editor = document.getElementById('email-content');
    editor.focus();
    document.execCommand('insertText', false, `{{${varName}}}`);
}

function getEditorContent() {
    const editor = document.getElementById('email-content');
    let html = editor.innerHTML;
    // Wrap in basic email template
    return `<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; line-height: 1.6;">
{{{trackingLogo}}}
${html}
</div>`;
}

// Sync
async function manualSync() {
    const btn = event.target.closest('.sync-btn');
    btn.disabled = true;
    document.getElementById('sync-status').textContent = 'Sync en cours...';
    await fetch(`${API}/api/sync-tracking`, { method: 'POST' });
    await Promise.all([loadStats(), loadTrackingTable()]);
    btn.disabled = false;
    document.getElementById('sync-status').textContent = 'Sync OK !';
    setTimeout(() => { document.getElementById('sync-status').textContent = 'Auto-sync: 30s'; }, 2000);
}

// Form
document.getElementById('campaign-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = {
        name: document.getElementById('campaign-name').value,
        subject: document.getElementById('campaign-subject').value,
        content: getEditorContent()
    };
    await fetch(`${API}/api/campaigns`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
    alert('Campagne cr√©√©e !');
    e.target.reset();
    document.getElementById('email-content').innerHTML = '';
    showSection('campaigns');
});

// Settings
async function saveSettings() {
    const dailyLimit = parseInt(document.getElementById('settings-daily-limit').value);
    if (dailyLimit < 1 || dailyLimit > 500) { alert('La limite doit √™tre entre 1 et 500'); return; }
    const res = await fetch(`${API}/api/settings`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ dailyLimit }) });
    if (res.ok) { currentSettings.dailyLimit = dailyLimit; alert('Param√®tres enregistr√©s !'); loadStats(); } else { alert('Erreur lors de la sauvegarde'); }
}

// Init
loadStats();
loadTrackingTable();
setInterval(() => { loadStats(); loadTrackingTable(); }, 30000);
</script>
</body>
</html>
